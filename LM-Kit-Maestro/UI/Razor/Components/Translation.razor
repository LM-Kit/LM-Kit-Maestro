@inject IClipboardHandler ClipboardHandler

<div id="container" class="dark">
    <div id="translation-container">
        <div id="translation-header">
            <div>
                <MudSelect Underline="false" class="language-select" @bind-Value="TranslationViewModel.InputLanguage">
                    @foreach (var language in GetAvailableLanguages(true))
                    {
                        if (language == Language.Undefined)
                        {
                            <MudSelectItem Value="Language.Undefined">Automatically detect</MudSelectItem>
                        }
                        else
                        {
                            <MudSelectItem Value="@language">@language</MudSelectItem>
                        }
                    }
                </MudSelect>
            </div>

            <button style="background-color: red" class="chatActionButton material-icons small">
                swap_horiz
            </button>

            <div>
                <MudSelect Underline="false" class="language-select" @bind-Value="TranslationViewModel.OutputLanguage">
                    @foreach (var language in GetAvailableLanguages(false))
                    {
                        <MudSelectItem Value="@language">@language</MudSelectItem>

                    }
                </MudSelect>
            </div>

            @*                 <MudSelect class="language-select" @bind-Value="TranslationViewModel.Language">
                    @foreach (var language in Enum.GetValues<Language>())
                    {
                        <MudSelectItem Value="@language">@language</MudSelectItem>

                    }
                </MudSelect> *@

            @* 
                <div class="language-select">
                    <label for="input-language">Input Language:</label>
                    <select id="input-language" @bind="TranslationViewModel.Language" class="multi-column-dropdown">
                        @foreach (var language in Enum.GetValues<Language>())
                        {
                            <option value="@language">@language</option>
                        }
                    </select>

                </div> *@
        </div>

        <div id="translation-body">
            <div id="translation-input">
                <textarea @bind="TranslationViewModel.InputText"
                          @bind:event="oninput"
                          placeholder="Enter text here..."></textarea>
            </div>

            <div id="translation-output">
                <textarea @bind="TranslationViewModel.LatestResult" placeholder="Translation will appear here..." readonly></textarea>
            </div>
        </div>

        <div id="translation-footer">
        </div>
    </div>
</div>

<style>
    #loaderDiv {
        display: flex;
        height: 72px;
        background-color: transparent;
        align-items: center;
        align-content: center;
        justify-content: center;
    }

    #container {
        width: 100%;
        padding-inline: 8px;
        padding-block: 8px;
    }

    #result {
        margin-block: 16px;
        background-color: var(--Surface15);
        color: white;
        min-height: 72px;
        margin-top: 10px;
        padding: 10px;
    }

    /*         #result:hover {
        background-color: var(--Surface3);
        } */

    #translation-container {
        display: flex;
        border: 1px solid var(--OutlineVariant);
        border-radius: 8px;
        overflow: hidden;
        display: grid;
        grid-template-rows: 40px auto auto;
    }

    #translation-input, #translation-output {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    #translation-header {
        display: flex;
        border-bottom: 1px solid var(--OutlineVariant);
        justify-content: space-between;
    }

    #translation-body {
        grid-template-columns: 1fr 1fr;
        display: grid;
        padding: 40px;
    }

    #translation-input {
        border-right: 1px solid #ddd;
    }

    #translation-output {
        background-color: #f9f9f9;
    }

        #translation-output textarea {
            border: none;
            color: white;
        }

            #translation-output textarea:focus {
                outline: none;
            }

    /*     .language-select {
        margin-bottom: 10px;
        }

        .language-select label {
        font-weight: bold;
        margin-right: 10px;
        } */

    textarea {
        width: 100%;
        height: 100%;
        resize: none;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

        textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 4px rgba(0, 123, 255, 0.5);
        }

    .language-select {
        background-color: red;
        width: 180px;
        vertical-align: central;
    }
</style>

@code
{

    // Using a timer to automatically refresh translation result when no user input is detected for a given time span.
    private Timer? _inputTimer;

    bool resultJustCopied;
    bool ResultJustCopied
    {
        get => resultJustCopied;
        set
        {
            resultJustCopied = value;
            InvokeAsync(() => StateHasChanged());
        }
    }

    [Parameter] public EventCallback OnSubmit { get; set; }

    [Parameter] public required TranslationViewModel TranslationViewModel { get; set; }

    [Parameter] public EventCallback<AssistantViewModelBase> TranslationViewModelChanged { get; set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        TranslationViewModel.PropertyChanged += OnTranslationViewModelPropertyChanged;
    }

    private async Task OnCopyResultButtonClicked()
    {
        bool success = await ClipboardHandler.CopyTextToClipboardAsync(TranslationViewModel.LatestResult != null ? TranslationViewModel.LatestResult : "");

        if (success)
        {
            if (!ResultJustCopied)
            {
                var _ = Task.Run(async () =>
                {
                    ResultJustCopied = true;
                    await Task.Delay(3000);
                    ResultJustCopied = false;
                });
            }
        }
    }

    private void OnTranslationViewModelPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(TranslationViewModel.InputText))
        {
            _inputTimer?.Change(Timeout.Infinite, Timeout.Infinite);
            _inputTimer = new Timer(OnDebounceTimerElapsed, null, 1000, Timeout.Infinite);
        }

        InvokeAsync(() => StateHasChanged());
    }

    private void OnDebounceTimerElapsed(object? state)
    {
        _inputTimer?.Change(Timeout.Infinite, Timeout.Infinite);
        TranslationViewModel.Submit();
    }

    private static List<Language> GetAvailableLanguages(bool inputLanguage)
    {
        var values = Enum.GetValues<Language>().Skip(1).ToList();

        values.Sort();

        if (inputLanguage)
        {
            values.Insert(0, Language.Undefined);
        }

        return values;
    }

}
